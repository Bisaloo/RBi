language: r
cache: packages
warnings_are_errors: false
sudo: required

os:
  - linux
  - osx

matrix:
  allow_failures:
    - os: linux

r_binary_packages:
  - magrittr
  - lazyeval
  - mime
  - curl
  - openssl
  - R6
  - jsonlite
  - httr
  - crayon
  - reshape2
  - ncdf4
  - data.table
  - coda
  - testthat
  - digest
  - praise

r_github_packages:
  - jimhester/covr

after_success:
  - Rscript -e 'library(covr); covr::codecov()'

before_install:
  - if [ -f ".git/shallow" ]; then travis_retry git fetch --unshallow; fi
  - if [ "${TRAVIS_OS_NAME}" = "osx" ]; then
      sudo chown -R $USER $(brew --repo);
      sudo chown -R $USER $(brew --prefix);
      brew tap homebrew/science;
      brew install gcc;
      brew link --overwrite gcc;
      brew install libbi;
    fi
  - if [ "${TRAVIS_OS_NAME}" = "linux" ]; then
      sudo mkdir -p /home/linuxbrew;
      sudo chown "$USER" /home/linuxbrew;
      LINUXBREW=/home/linuxbrew/.linuxbrew;
      git clone https://github.com/Linuxbrew/brew.git "$LINUXBREW";
      export PATH="$LINUXBREW/bin:$PATH";
      export LD_LIBRARY_PATH=$(echo $LD_LIBRARY_PATH | sed 's/:$//');
      brew tap homebrew/science;
      brew install --build-from-source curl;
      brew install --build-from-source cmake;
      brew install sbfnk/libbi/libbi --verbose;
      cat `which libbi`;
      export CPPFLAGS="-isystem/home/linuxbrew/.linuxbrew/include -I/home/linuxbrew/.linuxbrew/Cellar/libbi/1.3.0_2/include";
      libbi sample @`brew --cellar`/libbi/1.3.0_2/libexec/share/test/test.conf --model-file `brew --cellar`/libbi/1.3.0_2/libexec/share/test/Test.bi --verbose;
      brew test sbfnk/libbi/libbi;
      env;
    fi

